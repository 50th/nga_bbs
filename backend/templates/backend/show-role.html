{% extends "backend/show-base.html" %}
{% load my_tags %}

{% block extra-css %}
    <style type="text/css">
        .content-body {
            width: 50%;
            margin: auto;
        }
    </style>
{% endblock %}

{% block content-body %}
    {% csrf_token %}
    <div class="content-body">
        <table class="table table-bordered">
            <p>
                <button type="button" class="btn btn-success" data-toggle="modal" data-target="#addRoleModal">添加角色
                </button>
            </p>
            <thead>
            <tr>
                {% for f in role_fields %}
                    <th>{{ f.name }}</th>
                {% endfor %}
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            {% for r in role_lsit %}
                <tr>
                    <td>{{ r.id }}</td>
                    <td>{{ r.name }}</td>
                    <td>{% for p in r.permission.all %}{{ p.name }}\{% endfor %}</td>
                    <td>
                        <a class="btn btn-info btn-xs">修改</a>
                        <a class="btn btn-danger btn-xs">删除</a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>

        </table>

    </div>


    <!-- Modal -->
    <div class="modal fade" id="addRoleModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabel">添加角色</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="inputName">角色名</label>
                        <input type="text" class="form-control" id="inputName" placeholder="角色名">
                    </div>
                    <div class="form-group">
                        <label for="inputPermission">permission</label>
                        <select multiple="multiple" class="form-control" id="inputPermission">
                            {% for a in permission_list %}
                                <option value="{{ a.id }}">{{ a.name }}----{{ a.url_name }}----{{ a.get_action_display }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <span style="color: red" id="addErrorMsg"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" id="btnAddForum">添加</button>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        $(function () {
            $('#addRoleModal').on('hidden.bs.modal', function (e) {
                $("#inputName").val("");
                $("#inputPermission").val("");
                $("#addErrorMsg").text("");
            });
            $("#btnAddForum").click(function () {
                addRole();
            });
        });

        function addRole() {
            var name = $("#inputName").val();
            var permission = $("#inputPermission").val();
            var csrfToken = $("input[name='csrfmiddlewaretoken']").val();
            if (name && permission) {
                $.ajax({
                    url: "{% url "backend:role" %}",
                    method: "post",
                    data: {"roleData": JSON.stringify({"name": name, "permission":permission}), "csrfmiddlewaretoken": csrfToken},
                    dataType: "json",
                    success: function (res) {
                        if (res["status"]) {
                            window.location.reload();
                        } else {
                            $("#addErrorMsg").text(res["msg"]);
                        }
                    },
                });
            } else {
                $("#addErrorMsg").text("内容不能为空");
            }
        }

    </script>

{% endblock %}